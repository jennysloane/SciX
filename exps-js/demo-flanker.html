<!DOCTYPE html>
<html>
<head>
  <title> SciX </title>
  <script src="./js/jquery.min.js"></script>
  <script src="./js/jspsych.js"></script>
  <script src="./js/welcome.js"></script>
  <script src="./js/plugins/jspsych-instructions2.js"></script>
  <script src="./js/plugins/jspsych-html-button-response.js"></script>
  <script src="./js/plugins/jspsych-survey-multi-choice.js"></script>
  <script src="./js/plugins/jspsych-survey-multi-select.js"></script>
  <script src="./js/plugins/jspsych-html-keyboard-response.js"></script>
  <script src="./js/plugins/jspsych-html-slider-response.js"></script>
  <script src="./js/plugins/jspsych-instructions-time-limit.js"></script>
  <script src="./js/plugins/jspsych-image-keyboard-response.js"></script>
  <link rel="stylesheet" href="./js/css/jspsych.css"></link>

</head>
    <body>
    </body>
    <script>
    
  var pid = Math.floor(Math.random() * 100000);

  var turkcode = (Math.floor(Math.random() * 899999) + 100000).toString();

  var filename = "CRT_PID" + pid + "_turkcode_" + turkcode;

  function saveData(name, data){
  	var xhr = new XMLHttpRequest();
  	xhr.open('POST', 'save_data.php'); // 'write_data.php' is the path to the php file described above.
  	xhr.setRequestHeader('Content-Type', 'application/json');
  	xhr.send(JSON.stringify({filename: filename, filedata: data})); //specify a variable "filename"
  };

  function startExperiment(){

  	jsPsych.data.addProperties({
  		turkcode: turkcode,
  		pid: pid
  	});
    /* start the experiment */
    jsPsych.init({
      timeline: timeline,
      display_element: "jsPsych",
      on_trial_finish: function(data){saveData(filename, jsPsych.data.get().csv())}  // uncomment to locally save data file as csv
    });
   };

/* change the display property of a set of objects */
  function setDisplay(theClass, theValue) {
     var i, classElements = document.getElementsByClassName(theClass);
     for (i = 0; i < classElements.length; i = i + 1) {
      classElements[i].style.display = theValue;
     }
  };
/*
  var end = {
    type: 'html-keyboard-response',
    stimulus: ['<h3>The experiment is over. <p>Thank you!</p></h3>'],
    choices: jsPsych.NO_KEYS,
    trial_duration: 1000
  };
  */

  var end = {
    type: 'html-button-response',
    timing_post_trial: 0,
	  button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
    on_trial_start: function() { setTimeout(function() {setDisplay("jspsych-btn","")}, 5000000)},
    is_html: true,
    stimulus: '<h3>You\'re all finished - thank you for your help!</h3>' +
  	'<p>Your completion code is <span id="turkcode" style="font-weight:bold;font-size:115%">' + turkcode + '</span>. ' +
  	"You will be awarded the amount of <strong>$2.50</strong>.</p>" +
  	'To receive payment for the HIT, return to the Amazon Mechanical Turk page and enter this code. '+
  	'Please contact us if something goes wrong (unswcoglab@gmail.com) we\'ll fix it as quickly as possible.</p>',
    choices: ['Experiment over. You can now close this screen']
  };
        /* experiment parameters */
        var reps_per_trial_type = 4;

        /*set up welcome block*/
        var welcome = {
          type: "html-keyboard-response",
          stimulus: "Welcome to the experiment. Press any key to begin."
        };

        /*set up instructions block*/
        var instructions = {
          type: "html-keyboard-response",
          stimulus: "<p>In this task, you will see five arrows on the screen, like the example below.</p>"+
            "<img src='img/inc1.png'></img>"+
            "<p>Press the left arrow key if the middle arrow is pointing left. (<)</p>"+
            "<p>Press the right arrow key if the middle arrow is pointing right. (>)</p>"+
            "<p>Press any key to begin.</p>",
          post_trial_gap: 1000
        };

        /*defining stimuli*/
        var test_stimuli = [
          {
            stimulus: "img/con1.png",
            data: { stim_type: 'congruent', direction: 'left'}
          },
          {
            stimulus: "img/con2.png",
            data: { stim_type: 'congruent', direction: 'right'}
          },
          {
            stimulus: "img/inc1.png",
            data: { stim_type: 'incongruent', direction: 'right'}
          },
          {
            stimulus: "img/inc2.png",
            data: { stim_type: 'incongruent', direction: 'left'}
          }
        ];

        /* defining test timeline */
        var test = {
          timeline: [{
            type: 'image-keyboard-response',
            choices: [37, 39],
            trial_duration: 1500,
            stimulus: jsPsych.timelineVariable('stimulus'),
            data: jsPsych.timelineVariable('data'),
            on_finish: function(data){
              var correct = false;
              if(data.direction == 'left' &&  data.key_press == 37 && data.rt > -1){
                correct = true;
              } else if(data.direction == 'right' && data.key_press == 39 && data.rt > -1){
                correct = true;
              }
              data.correct = correct;
            },
            post_trial_gap: function() {
                return Math.floor(Math.random() * 1500) + 500;
            }
          }],
          timeline_variables: test_stimuli,
          sample: {type: 'fixed-repetitions', size: reps_per_trial_type}
        };

        /*defining debriefing block*/
        var debrief = {
          type: "html-keyboard-response",
          stimulus: function() {
            var total_trials = jsPsych.data.get().filter({trial_type: 'image-keyboard-response'}).count();
            var accuracy = Math.round(jsPsych.data.get().filter({correct: true}).count() / total_trials * 100);
            var congruent_rt = Math.round(jsPsych.data.get().filter({correct: true, stim_type: 'congruent'}).select('rt').mean());
            var incongruent_rt = Math.round(jsPsych.data.get().filter({correct: true, stim_type: 'incongruent'}).select('rt').mean());
            return "<p>You responded correctly on <strong>"+accuracy+"%</strong> of the trials.</p> " +
            "<p>Your average response time for congruent trials was <strong>" + congruent_rt + "ms</strong>.</p>"+
            "<p>Your average response time for incongruent trials was <strong>" + incongruent_rt + "ms</strong>.</p>"+
            "<p>Press any key to complete the experiment. Thank you!</p>";
          }
        };

        /*set up experiment structure*/
        var timeline = [];
        timeline.push(welcome);
        timeline.push(instructions);
        timeline.push(test);
        timeline.push(debrief);
        timeline.push(end);

        /*start experiment*/
        jsPsych.init({
            timeline: timeline,
            on_finish: function() {
                jsPsych.data.displayData();
            }
        });
    </script>
</html>
